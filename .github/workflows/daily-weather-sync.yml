name: Daily Weather Data Sync

on:
  schedule:
    # æ¯æ—¥ JST 8:00 (UTC 23:00å‰æ—¥) ã«å®Ÿè¡Œ - å‰æ—¥ã¨å‰ã€…æ—¥ã®å¤©æ°—ã‚’åŒæœŸ
    - cron: '0 23 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      start_date:
        description: 'é–‹å§‹æ—¥ (YYYY-MM-DDå½¢å¼ã€çœç•¥æ™‚ã¯å‰ã€…æ—¥)'
        required: false
        type: string
      end_date:
        description: 'çµ‚äº†æ—¥ (YYYY-MM-DDå½¢å¼ã€çœç•¥æ™‚ã¯å‰æ—¥)'
        required: false
        type: string

jobs:
  sync-weather-data:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        env:
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          # å‡¦ç†å¯¾è±¡æ—¥ä»˜ã®æ±ºå®š
          if [ -n "${{ github.event.inputs.start_date }}" ]; then
            # æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼šæŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã‚’ä½¿ç”¨
            START_DATE="${{ github.event.inputs.start_date }}"
            echo "æ‰‹å‹•å®Ÿè¡Œ: é–‹å§‹æ—¥ $START_DATE ã‚’å‡¦ç†ã—ã¾ã™"
            
            if [ -n "${{ github.event.inputs.end_date }}" ]; then
              END_DATE="${{ github.event.inputs.end_date }}"
              echo "çµ‚äº†æ—¥: $END_DATE"
            else
              END_DATE="$START_DATE"
              echo "çµ‚äº†æ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€é–‹å§‹æ—¥ã¨åŒã˜ã«ã—ã¾ã™"
            fi
          else
            # å®šæœŸå®Ÿè¡Œæ™‚ï¼šJSTåŸºæº–ã§å‰æ—¥ã¨å‰ã€…æ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
            # UTC 23:00 = JST 8:00 (ç¿Œæ—¥) ãªã®ã§ã€JSTåŸºæº–ã§å‰æ—¥ãƒ»å‰ã€…æ—¥ã‚’å–å¾—
            START_DATE=$(TZ='Asia/Tokyo' date -d '2 days ago' +'%Y-%m-%d')
            END_DATE=$(TZ='Asia/Tokyo' date -d 'yesterday' +'%Y-%m-%d')
            echo "å®šæœŸå®Ÿè¡Œ: JSTåŸºæº–ã§å‰ã€…æ—¥ ($START_DATE) ã‹ã‚‰å‰æ—¥ ($END_DATE) ã¾ã§ã‚’å‡¦ç†ã—ã¾ã™"
          fi

          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          cd src/weather
          echo "å¤©æ°—ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’é–‹å§‹ã—ã¾ã™..."
          python update_weather.py "$START_DATE" "$END_DATE" --yes

          if [ $? -eq 0 ]; then
            echo "âœ… å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: å®Ÿè¡Œçµæœã®é€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ Weather Data Sync: æˆåŠŸ"
          else
            echo "ğŸ’¥ Weather Data Sync: å¤±æ•— - ç®¡ç†è€…ã«é€šçŸ¥ã•ã‚Œã¾ã™"
          fi
