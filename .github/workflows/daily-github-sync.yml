name: Daily GitHub Activity Sync

on:
  schedule:
    # æ¯æ—¥ JST 24:30 (UTC 15:30) ã«å®Ÿè¡Œ - å‰æ—¥åˆ†ã®GitHubæ´»å‹•ã‚’åŒæœŸ
    - cron: '30 15 * * *'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      date:
        description: 'å‡¦ç†å¯¾è±¡æ—¥ä»˜ (YYYYMMDDå½¢å¼ã€çœç•¥æ™‚ã¯æ˜¨æ—¥)'
        required: false
        type: string

jobs:
  sync-github-activity:
    runs-on: ubuntu-latest

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: GitHubæ´»å‹•ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸ
        env:
          # GitHub ActionsãŒè‡ªå‹•æä¾›ï¼ˆå…¨ãƒªãƒã‚¸ãƒˆãƒªã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ä»˜ãï¼‰
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          # Secretsã§è¨­å®šãŒå¿…è¦
          NOTION_SECRET: ${{ secrets.NOTION_SECRET }}
          DATABASE_ID: ${{ secrets.DATABASE_ID }}
        run: |
          # å‡¦ç†å¯¾è±¡æ—¥ä»˜ã®æ±ºå®š
          if [ -n "${{ github.event.inputs.date }}" ]; then
            # æ‰‹å‹•å®Ÿè¡Œæ™‚ï¼šæŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã‚’ä½¿ç”¨
            TARGET_DATE="${{ github.event.inputs.date }}"
            echo "æ‰‹å‹•å®Ÿè¡Œ: æŒ‡å®šæ—¥ä»˜ $TARGET_DATE ã‚’å‡¦ç†ã—ã¾ã™"
          else
            # å®šæœŸå®Ÿè¡Œæ™‚ï¼šJSTåŸºæº–ã§æ˜¨æ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—
            # UTC 15:30 = JST 24:30ãªã®ã§ã€JSTåŸºæº–ã§å‰æ—¥ã‚’å–å¾—
            TARGET_DATE=$(TZ='Asia/Tokyo' date -d 'yesterday' +'%Y%m%d')
            echo "å®šæœŸå®Ÿè¡Œ: JSTåŸºæº–ã§æ˜¨æ—¥ ($TARGET_DATE) ã‚’å‡¦ç†ã—ã¾ã™"
          fi

          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
          cd src/github
          echo "GitHubæ´»å‹•ãƒ‡ãƒ¼ã‚¿åŒæœŸã‚’é–‹å§‹ã—ã¾ã™..."
          python github_notion.py $TARGET_DATE

          if [ $? -eq 0 ]; then
            echo "âœ… GitHubæ´»å‹•ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âŒ GitHubæ´»å‹•ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ"
            exit 1
          fi

      - name: å®Ÿè¡Œçµæœã®é€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ GitHub Activity Sync: æˆåŠŸ"
          else
            echo "ğŸ’¥ GitHub Activity Sync: å¤±æ•— - ç®¡ç†è€…ã«é€šçŸ¥ã•ã‚Œã¾ã™"
          fi
